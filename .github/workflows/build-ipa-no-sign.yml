name: Build IPA No Sign

on:
  workflow_dispatch: # Cho phÃ©p cháº¡y thá»§ cÃ´ng

jobs:
  build:
    name: Build iOS IPA
    runs-on: macos-latest

    defaults:
      run:
        working-directory: ./ipa

    steps:
      - name: ğŸ— Check out repository
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          # [QUAN TRá»ŒNG] Äá»ƒ cache rá»—ng Ä‘á»ƒ Ã©p GitHub khÃ´ng Ä‘Æ°á»£c tÃ¬m cache cÅ©
          cache: '' 

      - name: âš™ï¸ Setup EAS CLI
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: ğŸ’£ Nuke & Reinstall Dependencies
        # TÃ¨o gá»i bÆ°á»›c nÃ y lÃ  "Há»§y diá»‡t & LÃ m láº¡i"
        # XÃ³a node_modules vÃ  package-lock cÅ© Ä‘á»ƒ trÃ¡nh xung Ä‘á»™t
        run: |
          rm -rf node_modules
          rm -f package-lock.json
          npm cache clean --force
          npm install --legacy-peer-deps

      - name: ğŸš€ Build IPA
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
          NPM_CONFIG_LEGACY_PEER_DEPS: "true"
        # ThÃªm cá» --clear-cache Ä‘á»ƒ Expo cÅ©ng khÃ´ng Ä‘Æ°á»£c nhá»› cÃ¡i cÅ©
        run: eas build --platform ios --profile preview --local --non-interactive --output app.ipa --clear-cache

      - name: ğŸ“¤ Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-ipa
          path: ipa/app.ipa